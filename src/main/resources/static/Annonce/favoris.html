<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mes Favoris | EtudLife</title>

    <!-- CSS partag√© -->
    <link rel="stylesheet" href="/Annonce/annonces.css">
</head>

<body>

<section class="favoris-container">

    <!-- üîô Retour -->
    <button class="btn-blue" onclick="window.location.href='/Annonce/annonces.html'" style="margin-bottom:20px;">
        ‚Üê Retour aux annonces
    </button>

    <h1>Mes Favoris</h1>
    <p class="subtitle">Retrouvez toutes les annonces que vous avez aim√©es</p>

    <div class="card-stats">
        <div class="stat-left">
            <span class="stat-icon">‚ù§Ô∏è</span>
            <div class="stat-info">
                <h2 id="fav-count-display">0</h2>
                <p>Annonces favorites</p>
            </div>
        </div>

        <button class="btn-blue btn-small" onclick="window.location.href='/Annonce/annonces.html'">
            + D√©couvrir plus d‚Äôannonces
        </button>
    </div>

    <!-- ü©∂ Zone vide -->
    <div id="empty-favoris" class="empty-favoris hidden">
        <div class="empty-icon">ü§ç</div>
        <h3>Aucun favori pour le moment</h3>
        <p>Commencez √† ajouter des annonces √† vos favoris pour les retrouver ici</p>

        <button class="btn-blue" onclick="window.location.href='/Annonce/annonces.html'">
            üîç Parcourir les annonces
        </button>
    </div>

    <!-- üü• Grille de favoris -->
    <div id="favoris-list" class="annonces-grid"></div>

</section>

<script>
    /* ============================
       üîê S√âCURIT√â UTILISATEUR
    ============================ */
    const user = JSON.parse(localStorage.getItem("utilisateur"));
    if (!user) {
        alert("‚ö†Ô∏è Vous devez vous connecter pour acc√©der aux favoris.");
        window.location.href = "/login.html";
    }

    /* ============================
       üñº IMAGE BASE64
    ============================ */
    function getImageSrc(a) {
        return a.image
            ? `data:image/jpeg;base64,${a.image}`
            : "/images/default.jpg";
    }

    /* ============================
       ‚ù§Ô∏è CHARGEMENT DES FAVORIS
    ============================ */
    const favContainer = document.getElementById("favoris-list");
    const emptySection = document.getElementById("empty-favoris");
    const favCountDisplay = document.getElementById("fav-count-display");

    const key = `favoris_user_${user.id}`;
    let favoris = JSON.parse(localStorage.getItem(key)) || [];

    favCountDisplay.textContent = favoris.length;

    if (favoris.length === 0) {
        emptySection.classList.remove("hidden");
    } else {
        displayFavoris();
    }

    /* ============================
       üü• AFFICHAGE DES FAVORIS
    ============================ */
    function displayFavoris() {
        favContainer.innerHTML = favoris.map(a => `
        <div class="card-pro">

            <div class="card-img-wrapper">
                <img src="${getImageSrc(a)}" class="card-img" alt="Image annonce">
                <span class="cat-badge">${a.categorie}</span>
            </div>

            <div class="card-body">
                <h3>${a.titre}</h3>
                <p>${a.description.substring(0,100)}...</p>

                <div class="price-date">
                    <span class="price">${a.prix}</span>
                    <span class="date">${a.datePublication}</span>
                </div>

                <div class="icons">
                    <p>üìç ${a.ville}</p>
                    <p>üë§ ${a.auteur}</p>
                </div>

                <div class="card-actions">
                    <button class="btn-details" onclick="openDetails(${a.id})">
                        Voir d√©tails
                    </button>

                    <button class="btn-fav active" onclick="removeFavori(${a.id})">
                        ‚ù§Ô∏è
                    </button>
                </div>
            </div>
        </div>
    `).join("");
    }

    /* ============================
       ‚ùå SUPPRIMER UN FAVORI
    ============================ */
    function removeFavori(id) {
        favoris = favoris.filter(f => f.id !== id);
        localStorage.setItem(key, JSON.stringify(favoris));

        favCountDisplay.textContent = favoris.length;

        if (favoris.length === 0) {
            favContainer.innerHTML = "";
            emptySection.classList.remove("hidden");
        } else {
            displayFavoris();
        }
    }

    /* ============================
       üîç VOIR D√âTAILS (REDIRECTION)
    ============================ */
    function openDetails(id) {
        localStorage.setItem("selected_annonce_id", id);
        window.location.href = "/Annonce/annonces.html";
    }
</script>

</body>
</html>
