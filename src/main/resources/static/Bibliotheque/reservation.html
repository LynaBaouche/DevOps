<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>R√©servations ‚Äì BU</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="../header.css">
    <link rel="stylesheet" href="bu.css">
    <link rel="stylesheet" href="subheader.css">
</head>

<body>

<script src="../header.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const header = document.querySelector('.main-header');
        if (header) {
            // D√©tection de la page actuelle
            const path = window.location.pathname;
            const isCatalogue = path.includes('catalogue.html');
            const isReservation = path.includes('reservation.html');
            const isPlaces = path.includes('places.html');
            const isServices = path.includes('services.html');

            const subMenuHTML = `
                <nav class="bu-submenu">
                    <a href="catalogue.html" class="${isCatalogue ? 'active' : ''}">Catalogue</a>
                    <a href="reservation.html" class="${isReservation ? 'active' : ''}">Mes R√©servations</a>
                    <a href="places.html" class="${isPlaces ? 'active' : ''}">R√©server une Place</a>
                    <a href="services.html" class="${isServices ? 'active' : ''}">Services</a>
                </nav>`;
            header.insertAdjacentHTML('beforeend', subMenuHTML);
        }
    });
</script>

<main class="page">

    <h1 class="page-title">Mes r√©servations</h1>

    <!-- Conteneur o√π JS va injecter les r√©servations-->
    <section id="reservationContainer" class="reservations-list"></section>

</main>
<script>
    const userId = 1;

    async function loadReservations() {
      try {
        // üî• Utilise bien les backticks ` pour que ${userId} fonctionne
        const res = await fetch(`http://localhost:8080/api/reservation/utilisateur/${userId}`);

        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const reservations = await res.json();

        const withBooks = await Promise.all(
          reservations.map(async (r) => {
            let livre = null;
            try {
              // üî• Correction de l'URL pour correspondre √† ton LivreController (/api/livres)
              const lr = await fetch(`http://localhost:8080/api/livres`);
              if (lr.ok) {
                  const tousLesLivres = await lr.json();
                  // On cherche le livre correspondant √† l'ID de la r√©servation
                  livre = tousLesLivres.find(l => l.id === r.idLivre);
              }
            } catch (_) {}
            return { ...r, livre };
          })
        );

        renderReservations(withBooks);
      } catch (e) {
        console.error("Erreur chargement r√©servations :", e);
      }
    }

    function renderReservations(reservations) {
      const container = document.getElementById("reservationContainer");
      container.innerHTML = "";

      if (!reservations || reservations.length === 0) {
        container.innerHTML = "<p>Aucune r√©servation pour le moment.</p>";
        return;
      }

      reservations.forEach(r => {
        const card = document.createElement("article");
        card.className = "book-card";

        const titre = r.livre?.titre ?? `Livre #${r.idLivre}`;
        const auteur = r.livre?.auteur ?? "Auteur inconnu";

        card.innerHTML = `
          <div class="book-header">
            <div class="book-info">
              <div class="book-title">${titre}</div>
              <div class="book-author">${auteur}</div>
              <span class="badge badge-available">
                ${r.empruntDomicile ? "Emprunt √† domicile" : "Consultation sur place"}
              </span>
            </div>
          </div>
          <div class="book-footer">
            <span>
              R√©serv√© le : ${r.dateReservation ?? ""}<br>
              R√©cup√©ration : ${r.dateRecuperation ?? ""}
            </span>
            <button class="btn-danger" style="background-color: #ff4d4d; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px;"
                    onclick="annulerReservation(${r.id})">Annuler</button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    async function annulerReservation(id) {
      if (!confirm("Voulez-vous vraiment annuler cette r√©servation ?")) return;
      try {
          const res = await fetch(`http://localhost:8080/api/reservation/${id}`, { method: "DELETE" });
          if (res.ok) {
              alert("R√©servation annul√©e.");
              loadReservations(); // Recharge la liste
          }
      } catch (e) {
          alert("Erreur lors de l'annulation");
      }
    }

    loadReservations();
</script>

<script src="/app.js"></script>
</body>
</html>
