<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mes Annonces | EtudLife</title>

    <!-- CSS global -->
    <link rel="stylesheet" href="/Annonce/annonces.css">
    <link rel="stylesheet" href="/header.css">

    <!-- Script JS global annonces (cartes + modale) -->
    <script defer src="/Annonce/annonces.js"></script>

    <!-- S√©curit√© connexion -->
    <script>
        const userCheck = JSON.parse(localStorage.getItem("utilisateur"));
        if (!userCheck) {
            alert("‚ö†Ô∏è Vous devez vous connecter pour acc√©der √† vos annonces.");
            window.location.href = "/login.html";
        }
    </script>

    <script>
        // =========================================================
        // üñº IMAGE BASE64 (m√™me logique que annonces.js)
        // =========================================================
        function getImageSrc(a) {
            return a.image
                ? `data:image/jpeg;base64,${a.image}`
                : "/images/default.jpg";
        }

        // =========================================================
        // üüß CHARGEMENT DES ANNONCES DE L‚ÄôUTILISATEUR
        // =========================================================
        document.addEventListener("DOMContentLoaded", () => {

            if (!window.location.href.includes("mes_annonces.html")) return;

            const user = JSON.parse(localStorage.getItem("utilisateur"));
            if (!user) return;

            loadMesAnnonces(user.id);
        });

        async function loadMesAnnonces(userId) {

            const res = await fetch(`/api/annonces/utilisateur/${userId}`);
            const mesAnnonces = await res.json();

            // Stats
            document.getElementById("stat-publiees").textContent = mesAnnonces.length;
            document.getElementById("stat-vues").textContent =
                mesAnnonces.reduce((t, a) => t + a.vues, 0);

            // Cartes
            const container = document.getElementById("mes-annonces-list");

            container.innerHTML = mesAnnonces.map(a => `
        <div class="card-pro">

            <div class="card-img-wrapper">
                <img src="${getImageSrc(a)}" class="card-img" alt="Image annonce">
                <span class="cat-badge">${a.categorie}</span>
            </div>

            <div class="card-body">
                <h3>${a.titre}</h3>
                <p>${a.description.substring(0, 100)}...</p>

                <div class="price-date">
                    <span class="price">${a.prix} ‚Ç¨</span>
                    <span class="date">${a.datePublication}</span>
                </div>

                <div class="icons">
                    <p>üìç ${a.ville}</p>
                </div>

                <div class="card-actions">
                    <button class="btn-details" onclick="window.location.href='/Annonce/modifier.html?id=${a.id}'">
                        Modifier
                    </button>

                    <button class="btn-delete" onclick="supprimerAnnonce(${a.id})">
                        üóë
                    </button>
                </div>
            </div>

        </div>
    `).join("");
        }

        async function supprimerAnnonce(id) {
            if (!confirm("Voulez-vous supprimer cette annonce ?")) return;

            const res = await fetch(`/api/annonces/${id}`, { method: "DELETE" });

            if (res.ok) {
                const user = JSON.parse(localStorage.getItem("utilisateur"));
                if (user) {
                    const key = `favoris_user_${user.id}`;
                    let favoris = [];

                    try {
                        favoris = JSON.parse(localStorage.getItem(key)) || [];
                    } catch (e) {
                        favoris = [];
                    }

                    favoris = favoris.filter(f => f.id !== id);
                    localStorage.setItem(key, JSON.stringify(favoris));
                }

                loadMesAnnonces(user.id);
            } else {
                alert("‚ùå Erreur lors de la suppression.");
            }
        }
    </script>

    <script>
        // =========================================================
        // üîµ MODAL : OUVRIR / FERMER LA CR√âATION D'ANNONCE
        // =========================================================
        document.addEventListener("DOMContentLoaded", () => {

            const openBtn = document.getElementById("btn-create-annonce");
            const modal = document.getElementById("create-modal");
            const closeBtn = document.getElementById("close-create-modal");
            const cancelBtn = document.getElementById("cancel-create-modal");

            if (!modal) return;

            if (openBtn) {
                openBtn.addEventListener("click", () => {
                    modal.classList.remove("hidden");
                });
            }

            if (closeBtn) {
                closeBtn.addEventListener("click", () => {
                    modal.classList.add("hidden");
                });
            }

            if (cancelBtn) {
                cancelBtn.addEventListener("click", () => {
                    modal.classList.add("hidden");
                });
            }
        });
    </script>

    <script>
        // =========================================================
        // üöÄ CR√âATION D‚ÄôUNE ANNONCE (POST)
        // =========================================================
        document.addEventListener("DOMContentLoaded", () => {

            const form = document.getElementById("form-create-annonce");
            const modal = document.getElementById("create-modal");

            if (!form) return;

            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                const user = JSON.parse(localStorage.getItem("utilisateur"));
                if (!user) {
                    alert("Vous devez √™tre connect√©.");
                    return;
                }

                const imageInput = document.getElementById("image");
                if (!imageInput.files.length) {
                    alert("Veuillez s√©lectionner une image.");
                    return;
                }

                const fd = new FormData();
                fd.append("titre", document.getElementById("titre").value);
                fd.append("categorie", document.getElementById("categorie").value.toLowerCase());
                fd.append("prix", document.getElementById("prix").value);
                fd.append("ville", document.getElementById("ville").value);
                fd.append("description", document.getElementById("description").value);
                fd.append("auteur", user.prenom + " " + user.nom);
                fd.append("utilisateurId", user.id);
                fd.append("lien", document.getElementById("lien").value);
                fd.append("image", document.getElementById("image").files[0]);

                const res = await fetch("/api/annonces", {
                    method: "POST",
                    body: fd
                });

                if (!res.ok) {
                    alert("Erreur lors de la publication.");
                    return;
                }

                alert("‚úÖ Annonce publi√©e !");
                window.location.href = "/Annonce/annonces.html";
            });
        });
    </script>

</head>

<body class="page-annonces">

<script src="/header.js"></script>

<section class="mes-annonces-container">

    <button class="btn-blue" onclick="window.location.href='/Annonce/annonces.html'" style="margin-bottom:20px;">
        ‚Üê Retour aux annonces
    </button>

    <div class="mes-annonces-header">
        <div>
            <h1>Mes Annonces</h1>
            <p class="subtitle">G√©rez vos annonces publi√©es</p>
        </div>

        <button id="btn-create-annonce" class="create-btn">
            + Cr√©er une annonce
        </button>
    </div>

    <div class="stats-mes-annonces">
        <div class="stat-box">
            <div class="stat-icon blue">üìÑ</div>
            <div>
                <h2 id="stat-publiees">0</h2>
                <p>Annonces publi√©es</p>
            </div>
        </div>

        <div class="stat-box">
            <div class="stat-icon green">üëÅÔ∏è</div>
            <div>
                <h2 id="stat-vues">0</h2>
                <p>Vues totales</p>
            </div>
        </div>
    </div>

    <div id="mes-annonces-list" class="annonces-grid"></div>

</section>

<div id="create-modal" class="modal hidden">
    <div class="modal-overlay"></div>

    <div class="modal-box">

        <div class="modal-header">
            <h2>Cr√©er une annonce</h2>
            <span class="modal-close" id="close-create-modal">&times;</span>
        </div>

        <form id="form-create-annonce" class="modal-form">

            <label>Titre de l'annonce *</label>
            <input type="text" id="titre" placeholder="Ex: Chambre meubl√©e proche campus" required>

            <label>Cat√©gorie *</label>
            <select id="categorie" required>
                <option value="">S√©lectionner‚Ä¶</option>
                <option>Logement</option>
                <option>Cours</option>
                <option>Emploi</option>
                <option>Service</option>
                <option>Objet</option>
            </select>

            <div class="form-row">
                <div>
                    <label>Prix *</label>
                    <input type="text" id="prix" placeholder="Ex: 450">
                </div>

                <div>
                    <label>Localisation *</label>
                    <input type="text" id="ville" placeholder="Ex: Quartier Latin">
                </div>
            </div>

            <label>Description *</label>
            <textarea id="description" placeholder="D√©crivez votre annonce en d√©tail‚Ä¶" maxlength="500"
                      required></textarea>

            <label>Lien vers l‚Äôannonce (optionnel)</label>
            <input type="url" id="lien" placeholder="https://exemple.com/annonce">

            <label>Photo de l‚Äôannonce *</label>
            <input type="file" id="image" accept="image/*" required>

            <div class="modal-footer">
                <button type="button" class="btn-cancel" id="cancel-create-modal">Annuler</button>
                <button type="submit" class="btn-submit">Publier l‚Äôannonce</button>
            </div>
        </form>

    </div>
</div>

</body>
</html>
