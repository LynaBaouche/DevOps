name: Release & Documentation PDF

on:
  push:
    tags:
      - 'v*' # Se déclenche sur les tags comme v-alpha.0, v1.0, etc.

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout code
        uses: actions/checkout@v4


      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew


      - name: Build with Gradle
        run: ./gradlew bootJar
      # 1. On installe Node.js (nécessaire pour l'outil de conversion)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # 2. On installe les polices pour que les émojis s'affichent sur le serveur Linux
      - name: Install Fonts (Emojis fix)
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-color-emoji fonts-liberation

      # 3. On installe l'outil de conversion "md-to-pdf"
      - name: Install md-to-pdf
        run: npm install -g md-to-pdf

      - name: Generate PDF Documentation
        run: |
          md-to-pdf doc/documentation.md --launch-options '{"args": ["--no-sandbox"]}'
          mv doc/documentation.pdf Documentation_EtudLife.pdf

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            build/libs/*.jar
            Documentation_EtudLife.pdf
          draft: false
          prerelease: true
          generate_release_notes: true